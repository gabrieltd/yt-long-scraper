name: Parallel YouTube Discovery

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of queries per parallel job'
        required: true
        default: '10'
        type: string

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate Matrix
        id: set-matrix
        run: |
          # Count non-empty lines in queries.txt
          TOTAL_QUERIES=$(grep -cve '^\s*$' queries.txt)
          BATCH_SIZE=${{ inputs.batch_size }}
          
          echo "Total Queries: $TOTAL_QUERIES"
          echo "Batch Size: $BATCH_SIZE"
          
          # Calculate number of batches needed (ceiling division)
          # (total + batch_size - 1) / batch_size
          BATCH_COUNT=$(( (TOTAL_QUERIES + BATCH_SIZE - 1) / BATCH_SIZE ))
          
          echo "Batches needed: $BATCH_COUNT"
          
          # Generate JSON array [0, 1, ... N-1]
          # Since GitHub Actions matrix needs a JSON string
          MATRIX_JSON="["
          for (( i=0; i<BATCH_COUNT; i++ )); do
            MATRIX_JSON="$MATRIX_JSON$i"
            if [ $i -lt $((BATCH_COUNT-1)) ]; then
              MATRIX_JSON="$MATRIX_JSON, "
            fi
          done
          MATRIX_JSON="$MATRIX_JSON]"
          
          echo "Generated Matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  discovery:
    needs: prepare-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        batch_index: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Run Discovery Batch
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python run_discovery.py --batch-size ${{ inputs.batch_size }} --batch-index ${{ matrix.batch_index }}
