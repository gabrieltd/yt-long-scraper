name: Parallel YouTube Discovery

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of queries per parallel job'
        required: true
        default: '10'
        type: string

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Calculate Matrix
        id: set-matrix
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install -r requirements.txt
          
          # Use the python script to get exactly which batches have pending queries
          # This requires the DATABASE_URL to be present in this job's environment
          python run_discovery.py --check-batches --batch-size ${{ inputs.batch_size }} > matrix.json
          
          MATRIX_JSON=$(cat matrix.json)
          echo "Generated Matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  discovery:
    needs: prepare-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        batch_index: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Run Discovery Batch
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python run_discovery.py --batch-size ${{ inputs.batch_size }} --batch-index ${{ matrix.batch_index }}
