name: Parallel YouTube Discovery

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of queries per parallel job'
        required: true
        default: '10'
        type: string
      language:
        description: 'Language/Locale (EN for English, ES for Spanish)'
        required: false
        default: 'ES'
        type: choice
        options:
          - 'EN'
          - 'ES'
      upload_date:
        description: 'Filter by upload date'
        required: false
        type: choice
        options:
          - ''
          - 'last_hour'
          - 'today'
          - 'this_week'
          - 'this_month'
          - 'this_year'
      duration:
        description: 'Filter by video duration'
        required: false
        type: choice
        options:
          - ''
          - 'under_4'
          - '4_20'
          - 'over_20'
      sort_by:
        description: 'Sort results by'
        required: false
        type: choice
        options:
          - ''
          - 'relevance'
          - 'upload_date'
          - 'view_count'
          - 'rating'

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Calculate Matrix
        id: set-matrix
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install -r requirements.txt
          
          # Build command with language flag
          CMD="python run_discovery.py --check-batches --batch-size ${{ inputs.batch_size }}"
          
          if [ "${{ inputs.language }}" = "EN" ]; then
            CMD="$CMD --EN"
          else
            CMD="$CMD --ES"
          fi
          
          # Use the python script to get exactly which batches have pending queries
          # This requires the DATABASE_URL to be present in this job's environment
          $CMD > matrix.json
          
          MATRIX_JSON=$(cat matrix.json)
          echo "Generated Matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  discovery:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        batch_index: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-discovery.txt
          playwright install chromium

      - name: Run Discovery Batch
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Build command with all parameters
          CMD="python run_discovery.py --batch-size ${{ inputs.batch_size }} --batch-index ${{ matrix.batch_index }}"
          
          # Add language flag
          if [ "${{ inputs.language }}" = "EN" ]; then
            CMD="$CMD --EN"
          else
            CMD="$CMD --ES"
          fi
          
          # Add filters if specified
          if [ -n "${{ inputs.upload_date }}" ]; then
            CMD="$CMD --upload-date ${{ inputs.upload_date }}"
          fi
          
          if [ -n "${{ inputs.duration }}" ]; then
            CMD="$CMD --duration ${{ inputs.duration }}"
          fi
          
          if [ -n "${{ inputs.sort_by }}" ]; then
            CMD="$CMD --sort-by ${{ inputs.sort_by }}"
          fi
          
          echo "Running: $CMD"
          $CMD
